<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Shop Inventory Importer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; }
        .tab { padding: 15px 30px; background: none; border: none; font-size: 16px; cursor: pointer; color: #666; font-weight: 500; }
        .tab.active { color: #667eea; border-bottom: 3px solid #667eea; }
        .section { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .file-upload { border: 2px dashed #ddd; padding: 20px; border-radius: 8px; text-align: center; margin: 10px 0; }
        .file-upload input { width: 100%; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #48bb78; color: white; }
        .btn-success:hover { background: #38a169; }
        .btn-danger { background: #f56565; color: white; }
        .btn-danger:hover { background: #e53e3e; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .btn-row { display: flex; gap: 15px; margin: 20px 0; }
        .btn-row .btn { flex: 1; }
        .file-list { margin-top: 15px; }
        .file-item { background: #f7fafc; padding: 10px; border-radius: 5px; margin: 5px 0; display: flex; justify-content: space-between; align-items: center; }
        .file-item button { background: #f56565; color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .status { padding: 15px; border-radius: 8px; margin: 15px 0; font-weight: 500; }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.error { background: #fed7d7; color: #742a2a; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
        th { background: #f7fafc; font-weight: 600; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .stored-item { background: #f7fafc; padding: 15px; border-radius: 8px; margin: 10px 0; }
        .stored-item button { background: #f56565; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; float: right; }
        .image-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px; }
        .image-item { position: relative; }
        .image-item img { width: 100%; height: 100px; object-fit: cover; border-radius: 8px; }
        .image-item button { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; border: none; padding: 5px 10px; border-radius: 5px; cursor: pointer; }
        .instructions { background: #fef5e7; border-left: 4px solid #f39c12; padding: 20px; margin-top: 30px; border-radius: 5px; }
        .instructions h3 { margin-bottom: 10px; color: #d68910; }
        .instructions li { margin: 8px 0; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¥ Bike Shop Inventory Importer</h1>
            <p>Upload your files and generate a Shopify-ready CSV in seconds</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('upload')">üì§ Upload Files</button>
            <button class="tab" onclick="showTab('storage')">üíæ Stored Data (<span id="stored-count">0 files, 0 images</span>)</button>
        </div>

        <div id="upload-tab">
            <h2 style="margin-bottom: 20px;">üì¶ Lightspeed Migration</h2>
            <div class="grid">
                <div class="section">
                    <h3>üìä Product Inventory</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('inventorySheets', this)">
                    </div>
                    <div id="inventorySheets-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üë• Customer List</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('customerList', this)">
                    </div>
                    <div id="customerList-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üìà Sales Reports</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('salesReports', this)">
                    </div>
                    <div id="salesReports-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üìù Order History</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('orderHistory', this)">
                    </div>
                    <div id="orderHistory-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üí∞ Pricing / Discounts</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('pricing', this)">
                    </div>
                    <div id="pricing-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üìã Supplier Master Files</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('masterFiles', this)">
                    </div>
                    <div id="masterFiles-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üíª Lightspeed Full Export</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="handleUpload('lightspeedExports', this)">
                    </div>
                    <div id="lightspeedExports-list" class="file-list"></div>
                </div>

                <div class="section">
                    <h3>üìÑ Other Files (Invoices, etc.)</h3>
                    <div class="file-upload">
                        <input type="file" multiple accept=".pdf,.xlsx,.xls,.csv" onchange="handleUpload('otherFiles', this)">
                    </div>
                    <div id="otherFiles-list" class="file-list"></div>
                </div>
            </div>

            <div class="btn-row">
                <button class="btn btn-primary" onclick="processInventory()">‚öôÔ∏è Process Products</button>
                <button class="btn btn-primary" onclick="processCustomers()" style="background: #9f7aea;">üë• Process Customers</button>
                <button class="btn btn-success" id="download-products-btn" onclick="downloadCSV('products')" disabled>üì• Download Products CSV</button>
                <button class="btn btn-success" id="download-customers-btn" onclick="downloadCSV('customers')" disabled>üì• Download Customers CSV</button>
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>

            <div id="status"></div>
            <div id="preview" class="section hidden"></div>
        </div>

        <div id="storage-tab" class="hidden">
            <div class="section" style="background: linear-gradient(135deg, #667eea15, #764ba215);">
                <h2>üíæ Backup & Restore</h2>
                <p style="margin: 15px 0; color: #666;">Export your master files and images as a backup file. Import on any computer or share with employees.</p>
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="exportBackup()">üì§ Export Backup</button>
                    <button class="btn btn-success" onclick="document.getElementById('import-input').click()">üì• Import Backup</button>
                    <button class="btn btn-danger" onclick="clearAllStorage()">üóëÔ∏è Clear All Data</button>
                </div>
                <input type="file" id="import-input" accept=".json" onchange="importBackup(this)" style="display:none">
            </div>

            <div class="section">
                <h2>üìã Store Master Files</h2>
                <p style="margin: 15px 0; color: #666;">Upload supplier master files to store permanently. These will automatically enhance your inventory imports.</p>
                <input type="file" multiple accept=".xlsx,.xls,.csv" onchange="storeMasterFiles(this)">
                <div id="stored-masters"></div>
            </div>

            <div class="section">
                <h2>üñºÔ∏è Store Product Images</h2>
                <p style="margin: 15px 0; color: #666;">Upload bulk product images. Name files using SKU, UPC, or product name for automatic matching.</p>
                <input type="file" multiple accept="image/*" onchange="storeImages(this)">
                <div id="stored-images" class="image-grid"></div>
            </div>
        </div>

        <div class="instructions">
            <h3>üìã Lightspeed to Shopify Migration Guide</h3>
            <ol>
                <li><strong>Export from Lightspeed:</strong> Export your products, customers, inventory, sales reports, and pricing data from Lightspeed</li>
                <li><strong>Store Master Data:</strong> Go to "Stored Data" tab, upload supplier master files and product images (one-time setup)</li>
                <li><strong>Upload Migration Files:</strong> In "Upload Files" tab, upload all exported Lightspeed files</li>
                <li><strong>Process Products:</strong> Click "Process Products" to generate Shopify product CSV</li>
                <li><strong>Process Customers:</strong> Click "Process Customers" to generate Shopify customer CSV</li>
                <li><strong>Review Previews:</strong> Check the preview tables to ensure data looks correct</li>
                <li><strong>Download CSVs:</strong> Download both product and customer CSVs</li>
                <li><strong>Import to Shopify:</strong>
                    <ul style="margin-top: 5px;">
                        <li>Products: Shopify Admin ‚Üí Products ‚Üí Import</li>
                        <li>Customers: Shopify Admin ‚Üí Customers ‚Üí Import</li>
                    </ul>
                </li>
                <li><strong>Verify Data:</strong> Check imported data in Shopify and make adjustments if needed</li>
            </ol>
            
            <h4 style="margin-top: 20px;">üí° Tips for Best Results:</h4>
            <ul>
                <li>Name image files with SKU or UPC for automatic matching</li>
                <li>Export customers with order history for better lifetime value data</li>
                <li>Include pricing and discount data for accurate product pricing</li>
                <li>Use the backup feature to save your master files and images</li>
                <li>Test with a small batch first before importing all data</li>
            </ul>
        </div>
    </div>

    <script>
        const files = { 
            inventorySheets: [], 
            lightspeedExports: [], 
            masterFiles: [], 
            customerList: [],
            salesReports: [],
            orderHistory: [],
            pricing: [],
            otherFiles: []
        };
        let storedMasters = [];
        let storedImages = [];
        let processedData = [];
        let processedCustomers = [];

        async function loadStoredData() {
            try {
                const masterResult = await window.storage.list('master-file:');
                const imageResult = await window.storage.list('image:');
                
                if (masterResult?.keys) {
                    storedMasters = await Promise.all(
                        masterResult.keys.map(async (key) => {
                            const result = await window.storage.get(key);
                            return result ? JSON.parse(result.value) : null;
                        })
                    );
                    storedMasters = storedMasters.filter(f => f);
                }
                
                if (imageResult?.keys) {
                    storedImages = await Promise.all(
                        imageResult.keys.map(async (key) => {
                            const result = await window.storage.get(key);
                            return result ? JSON.parse(result.value) : null;
                        })
                    );
                    storedImages = storedImages.filter(i => i);
                }
                
                updateStoredDataDisplay();
            } catch (error) {
                console.log('No stored data found:', error);
            }
        }

        function updateStoredDataDisplay() {
            document.getElementById('stored-count').textContent = `${storedMasters.length} files, ${storedImages.length} images`;
            
            const mastersDiv = document.getElementById('stored-masters');
            mastersDiv.innerHTML = storedMasters.map((m, i) => `
                <div class="stored-item">
                    <button onclick="deleteMaster(${i})">Delete</button>
                    <strong>${m.fileName}</strong><br>
                    <small>${m.productCount} products ‚Ä¢ ${new Date(m.uploadDate).toLocaleDateString()}</small>
                </div>
            `).join('');
            
            const imagesDiv = document.getElementById('stored-images');
            imagesDiv.innerHTML = storedImages.map((img, i) => `
                <div class="image-item">
                    <img src="${img.dataUrl}" alt="${img.fileName}">
                    <button onclick="deleteImage(${i})">√ó</button>
                    <div style="font-size:11px; margin-top:5px;">${img.fileName}</div>
                </div>
            `).join('');
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('upload-tab').classList.toggle('hidden', tab !== 'upload');
            document.getElementById('storage-tab').classList.toggle('hidden', tab !== 'storage');
        }

        function handleUpload(category, input) {
            const newFiles = Array.from(input.files);
            files[category] = [...files[category], ...newFiles];
            updateFileList(category);
            showStatus(`Added ${newFiles.length} file(s)`, 'success');
        }

        function updateFileList(category) {
            const list = document.getElementById(`${category}-list`);
            list.innerHTML = files[category].map((file, i) => `
                <div class="file-item">
                    <span>${file.name}</span>
                    <button onclick="removeFile('${category}', ${i})">Remove</button>
                </div>
            `).join('');
        }

        function removeFile(category, index) {
            files[category].splice(index, 1);
            updateFileList(category);
        }

        function showStatus(msg, type = 'success') {
            const status = document.getElementById('status');
            status.className = `status ${type}`;
            status.textContent = msg;
        }

        async function storeMasterFiles(input) {
            for (const file of input.files) {
                try {
                    const data = file.name.endsWith('.csv') 
                        ? await readCSV(file)
                        : await readExcel(file);
                    
                    const headers = data[0].map(h => String(h || '').trim().toLowerCase());
                    const products = data.slice(1).map(row => {
                        const item = {};
                        headers.forEach((h, i) => item[h] = row[i]);
                        return item;
                    });
                    
                    const masterData = {
                        fileName: file.name,
                        uploadDate: new Date().toISOString(),
                        productCount: products.length,
                        products
                    };
                    
                    await window.storage.set(`master-file:${file.name}`, JSON.stringify(masterData));
                    showStatus(`Stored ${file.name} (${products.length} products)`, 'success');
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                }
            }
            loadStoredData();
        }

        async function storeImages(input) {
            for (const file of input.files) {
                if (!file.type.startsWith('image/')) continue;
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageData = {
                        fileName: file.name,
                        uploadDate: new Date().toISOString(),
                        dataUrl: e.target.result,
                        identifier: file.name.split('.')[0].toLowerCase().replace(/[^a-z0-9]/g, '')
                    };
                    await window.storage.set(`image:${imageData.identifier}`, JSON.stringify(imageData));
                    loadStoredData();
                };
                reader.readAsDataURL(file);
            }
            showStatus(`Storing ${input.files.length} images...`, 'success');
        }

        async function deleteMaster(index) {
            await window.storage.delete(`master-file:${storedMasters[index].fileName}`);
            loadStoredData();
        }

        async function deleteImage(index) {
            await window.storage.delete(`image:${storedImages[index].identifier}`);
            loadStoredData();
        }

        async function exportBackup() {
            const backup = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                masterFiles: storedMasters,
                images: storedImages
            };
            
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bike-shop-backup-${Date.now()}.json`;
            a.click();
            showStatus(`Backup created! (${storedMasters.length} files, ${storedImages.length} images)`, 'success');
        }

        async function importBackup(input) {
            try {
                const text = await input.files[0].text();
                const backup = JSON.parse(text);
                
                for (const m of backup.masterFiles) {
                    await window.storage.set(`master-file:${m.fileName}`, JSON.stringify(m));
                }
                for (const img of backup.images) {
                    await window.storage.set(`image:${img.identifier}`, JSON.stringify(img));
                }
                
                loadStoredData();
                showStatus(`Imported ${backup.masterFiles.length} files and ${backup.images.length} images!`, 'success');
            } catch (error) {
                showStatus(`Import error: ${error.message}`, 'error');
            }
        }

        async function clearAllStorage() {
            if (!confirm('Delete ALL stored data? This cannot be undone!')) return;
            
            const masterResult = await window.storage.list('master-file:');
            const imageResult = await window.storage.list('image:');
            
            if (masterResult?.keys) {
                for (const key of masterResult.keys) await window.storage.delete(key);
            }
            if (imageResult?.keys) {
                for (const key of imageResult.keys) await window.storage.delete(key);
            }
            
            storedMasters = [];
            storedImages = [];
            updateStoredDataDisplay();
            showStatus('All stored data deleted', 'success');
        }

        async function processInventory() {
            showStatus('Processing products...', 'success');
            const allData = [];
            
            const sheetsToProcess = [...files.inventorySheets, ...files.lightspeedExports];
            
            for (const file of sheetsToProcess) {
                const data = file.name.endsWith('.csv') ? await readCSV(file) : await readExcel(file);
                const headers = data[0].map(h => String(h || '').trim().toLowerCase());
                
                for (let i = 1; i < data.length; i++) {
                    if (!data[i] || data[i].length === 0) continue;
                    const item = {};
                    headers.forEach((h, idx) => item[h] = data[i][idx]);
                    
                    // Enhance with master file data
                    const masterData = findMasterData(item);
                    if (masterData) {
                        Object.keys(masterData).forEach(k => {
                            if (!item[k]) item[k] = masterData[k];
                        });
                    }
                    
                    // Enhance with pricing data
                    const pricingData = findPricingData(item);
                    if (pricingData) {
                        Object.keys(pricingData).forEach(k => {
                            if (!item[k]) item[k] = pricingData[k];
                        });
                    }
                    
                    allData.push(item);
                }
            }
            
            if (allData.length === 0) {
                showStatus('No product data found in files', 'error');
                return;
            }
            
            processedData = allData.map((item, i) => ({
                'Handle': (item.sku || item.handle || generateSKU(item, i)).toLowerCase().replace(/\s/g, '-'),
                'Title': item.name || item.title || item.description || 'Product',
                'Body (HTML)': generateDescription(item),
                'Vendor': item.brand || item.manufacturer || item.vendor || 'L\'Atelier Clandestin',
                'Product Category': item['product category'] || '',
                'Type': item.type || item.category || 'Bike Parts',
                'Tags': generateTags(item),
                'Published': 'TRUE',
                'Option1 Name': item['option1 name'] || 'Title',
                'Option1 Value': item['option1 value'] || item.size || 'Default Title',
                'Option1 Linked To': '',
                'Option2 Name': item['option2 name'] || '',
                'Option2 Value': item['option2 value'] || item.color || '',
                'Option2 Linked To': '',
                'Option3 Name': item['option3 name'] || '',
                'Option3 Value': item['option3 value'] || '',
                'Option3 Linked To': '',
                'Variant SKU': item.sku || generateSKU(item, i),
                'Variant Grams': item.weight || item.grams || '0',
                'Variant Inventory Tracker': 'shopify',
                'Variant Inventory Qty': item.quantity || item.qty || item['on hand'] || '0',
                'Variant Inventory Policy': 'deny',
                'Variant Fulfillment Service': 'manual',
                'Variant Price': item.price || item['retail price'] || item['sell price'] || item.msrp || '',
                'Variant Compare At Price': item.msrp || item['compare at price'] || item['list price'] || '',
                'Variant Requires Shipping': 'TRUE',
                'Variant Taxable': 'TRUE',
                'Unit Price Total Measure': '',
                'Unit Price Total Measure Unit': '',
                'Unit Price Base Measure': '',
                'Unit Price Base Measure Unit': '',
                'Variant Barcode': item.barcode || item.upc || item.ean || item.gtin || '',
                'Image Src': findMatchingImage(item),
                'Image Position': '1',
                'Image Alt Text': `${item.brand || ''} ${item.name || 'product'}`.trim(),
                'Gift Card': 'FALSE',
                'SEO Title': generateSEOTitle(item),
                'SEO Description': generateSEODescription(item),
                'Variant Image': '',
                'Variant Weight Unit': 'g',
                'Variant Tax Code': '',
                'Cost per item': item.cost || item['cost price'] || item['wholesale price'] || '',
                'Status': 'active'
            }));
            
            document.getElementById('download-products-btn').disabled = false;
            showPreview('products');
            showStatus(`Processed ${processedData.length} products!`, 'success');
        }

        async function processCustomers() {
            showStatus('Processing customers...', 'success');
            const allCustomers = [];
            
            const customerFiles = [...files.customerList, ...files.orderHistory];
            
            for (const file of customerFiles) {
                const data = file.name.endsWith('.csv') ? await readCSV(file) : await readExcel(file);
                const headers = data[0].map(h => String(h || '').trim().toLowerCase());
                
                for (let i = 1; i < data.length; i++) {
                    if (!data[i] || data[i].length === 0) continue;
                    const item = {};
                    headers.forEach((h, idx) => item[h] = data[i][idx]);
                    
                    // Only add if has customer info
                    if (item.email || item['customer email'] || item['customer name']) {
                        allCustomers.push(item);
                    }
                }
            }
            
            if (allCustomers.length === 0) {
                showStatus('No customer data found in files', 'error');
                return;
            }
            
            // Deduplicate by email
            const uniqueCustomers = {};
            allCustomers.forEach(c => {
                const email = (c.email || c['customer email'] || '').toLowerCase().trim();
                if (email && !uniqueCustomers[email]) {
                    uniqueCustomers[email] = c;
                }
            });
            
            processedCustomers = Object.values(uniqueCustomers).map(customer => ({
                'First Name': customer['first name'] || customer['customer first name'] || customer.firstname || '',
                'Last Name': customer['last name'] || customer['customer last name'] || customer.lastname || '',
                'Email': customer.email || customer['customer email'] || '',
                'Company': customer.company || customer['company name'] || '',
                'Address1': customer.address || customer.address1 || customer['street address'] || '',
                'Address2': customer.address2 || customer['address line 2'] || '',
                'City': customer.city || '',
                'Province': customer.province || customer.state || customer.region || '',
                'Province Code': customer['province code'] || customer['state code'] || '',
                'Country': customer.country || 'Canada',
                'Country Code': customer['country code'] || 'CA',
                'Zip': customer.zip || customer.postal || customer['postal code'] || customer.zipcode || '',
                'Phone': customer.phone || customer['phone number'] || customer.telephone || '',
                'Accepts Marketing': customer['accepts marketing'] || customer['email marketing'] || 'no',
                'Total Spent': customer['total spent'] || customer['lifetime value'] || '0.00',
                'Total Orders': customer['total orders'] || customer['order count'] || '0',
                'Tags': customer.tags || 'Lightspeed Import',
                'Note': `Imported from Lightspeed on ${new Date().toLocaleDateString()}`,
                'Tax Exempt': customer['tax exempt'] || 'no'
            }));
            
            document.getElementById('download-customers-btn').disabled = false;
            showPreview('customers');
            showStatus(`Processed ${processedCustomers.length} unique customers!`, 'success');
        }

        function findPricingData(item) {
            const sku = String(item.sku || '').toLowerCase().trim();
            
            for (const file of [...files.pricing]) {
                // This would need to be processed from stored pricing files
                // For now, return null
            }
            return null;
        }

        function findMasterData(item) {
            const sku = String(item.sku || '').toLowerCase();
            const upc = String(item.upc || '').toLowerCase();
            
            for (const master of storedMasters) {
                const match = master.products.find(p => 
                    String(p.sku || '').toLowerCase() === sku || 
                    String(p.upc || '').toLowerCase() === upc
                );
                if (match) return match;
            }
            return null;
        }

        function findMatchingImage(item) {
            const sku = String(item.sku || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const match = storedImages.find(img => 
                img.identifier === sku || img.identifier.includes(sku) || sku.includes(img.identifier)
            );
            return match ? match.dataUrl : '';
        }

        function generateSKU(item, i) {
            return item.sku || `${String(item.brand || '').substring(0,3)}${Date.now()}${i}`.replace(/\s/g, '');
        }

        function generateTags(item) {
            const tags = new Set();
            
            // Add from existing tags field
            if (item.tags) {
                const existingTags = String(item.tags).split(',');
                existingTags.forEach(tag => tags.add(tag.trim()));
            }
            
            // Add brand/manufacturer
            if (item.brand || item.manufacturer) {
                tags.add(String(item.brand || item.manufacturer).trim());
            }
            
            // Add category/type
            if (item.category || item.type) {
                tags.add(String(item.category || item.type).trim());
            }
            
            // Common bike part tags
            const name = String(item.name || item.description || '').toLowerCase();
            const bikeTerms = ['tire', 'wheel', 'brake', 'chain', 'pedal', 'saddle', 'handlebar', 
                               'fork', 'frame', 'gear', 'derailleur', 'cassette', 'crankset', 
                               'helmet', 'light', 'lock', 'pump', 'tube', 'rim', 'suspension',
                               'mtb', 'road', 'gravel', 'service', 'accessory'];
            
            bikeTerms.forEach(term => {
                if (name.includes(term)) {
                    tags.add(term.charAt(0).toUpperCase() + term.slice(1));
                }
            });
            
            return Array.from(tags).join(', ');
        }

        function generateSEOTitle(item) {
            return `${item.brand || ''} ${item.name || 'Product'}`.trim().substring(0, 70);
        }

        function generateSEODescription(item) {
            return `Shop ${item.brand || ''} ${item.name || 'product'} at competitive prices.`.substring(0, 320);
        }

        function generateDescription(item) {
            let html = `<h2>${item.name || 'Product'}</h2>`;
            if (item.brand) html += `<p><strong>Brand:</strong> ${item.brand}</p>`;
            if (item.description) html += `<p>${item.description}</p>`;
            return html;
        }

        function showPreview(type = 'products') {
            const preview = document.getElementById('preview');
            preview.classList.remove('hidden');
            
            if (type === 'products') {
                preview.innerHTML = `
                    <h3>üì¶ Products Preview (${processedData.length} products)</h3>
                    <table>
                        <tr><th>Image</th><th>SKU</th><th>Title</th><th>Vendor</th><th>Price</th><th>Qty</th></tr>
                        ${processedData.slice(0, 10).map(p => `
                            <tr>
                                <td>${p['Image Src'] ? '<img src="' + p['Image Src'] + '" style="width:40px;height:40px;object-fit:cover;border-radius:5px;">' : '‚Äî'}</td>
                                <td>${p['Variant SKU']}</td>
                                <td>${p.Title}</td>
                                <td>${p.Vendor}</td>
                                <td>${p['Variant Price']}</td>
                                <td>${p['Variant Inventory Qty']}</td>
                            </tr>
                        `).join('')}
                    </table>
                    ${processedData.length > 10 ? `<p style="margin-top:10px;color:#666;">+ ${processedData.length - 10} more products</p>` : ''}
                `;
            } else if (type === 'customers') {
                preview.innerHTML = `
                    <h3>üë• Customers Preview (${processedCustomers.length} customers)</h3>
                    <table>
                        <tr><th>Name</th><th>Email</th><th>Phone</th><th>City</th><th>Total Spent</th><th>Orders</th></tr>
                        ${processedCustomers.slice(0, 10).map(c => `
                            <tr>
                                <td>${c['First Name']} ${c['Last Name']}</td>
                                <td>${c.Email}</td>
                                <td>${c.Phone}</td>
                                <td>${c.City}</td>
                                <td>${c['Total Spent']}</td>
                                <td>${c['Total Orders']}</td>
                            </tr>
                        `).join('')}
                    </table>
                    ${processedCustomers.length > 10 ? `<p style="margin-top:10px;color:#666;">+ ${processedCustomers.length - 10} more customers</p>` : ''}
                `;
            }
        }

        function downloadCSV(type = 'products') {
            if (type === 'products' && processedData.length === 0) return;
            if (type === 'customers' && processedCustomers.length === 0) return;
            
            const data = type === 'products' ? processedData : processedCustomers;
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopify_${type}_import_${Date.now()}.csv`;
            a.click();
            
            showStatus(`Downloaded ${type} CSV successfully!`, 'success');
        }

        function clearAll() {
            Object.keys(files).forEach(k => files[k] = []);
            Object.keys(files).forEach(updateFileList);
            processedData = [];
            processedCustomers = [];
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('download-products-btn').disabled = true;
            document.getElementById('download-customers-btn').disabled = true;
            showStatus('Cleared all uploaded files', 'success');
        }

        function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    resolve(XLSX.utils.sheet_to_json(sheet, { header: 1 }));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        function readCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    complete: (r) => resolve(r.data),
                    error: reject,
                    skipEmptyLines: true
                });
            });
        }

        loadStoredData();
    </script>
</body>
</html>