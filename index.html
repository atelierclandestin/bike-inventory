<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L'Atelier Clandestin - Shopify Import Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 10px; margin-bottom: 30px; }
        .header h1 { font-size: 36px; margin-bottom: 10px; }
        .tabs { display: flex; gap: 5px; margin-bottom: 25px; background: white; border-radius: 10px 10px 0 0; padding: 10px; }
        .tab { padding: 15px 30px; background: none; border: none; font-size: 16px; cursor: pointer; color: #666; font-weight: 600; border-radius: 8px; }
        .tab.active { color: #667eea; background: #f0f4ff; }
        .section { background: white; padding: 30px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); }
        .section h2 { font-size: 24px; margin-bottom: 15px; color: #333; }
        .btn { padding: 14px 28px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .btn-primary { background: #667eea; color: white; }
        .btn-primary:hover { background: #5568d3; }
        .btn-success { background: #48bb78; color: white; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; }
        .btn-row { display: flex; gap: 15px; margin: 25px 0; flex-wrap: wrap; }
        .file-upload { border: 2px dashed #ddd; padding: 30px; border-radius: 8px; text-align: center; margin: 15px 0; background: #fafafa; }
        .status { padding: 15px 20px; border-radius: 8px; margin: 20px 0; font-weight: 500; }
        .status.success { background: #c6f6d5; color: #22543d; }
        .status.error { background: #fed7d7; color: #742a2a; }
        .status.info { background: #bee3f8; color: #2c5282; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; color: #2d3748; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 2px solid #e2e8f0; border-radius: 6px; }
        .supplier-card { background: #f7fafc; padding: 20px; border-radius: 10px; margin: 15px 0; border-left: 4px solid #667eea; }
        .hidden { display: none; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #e2e8f0; }
        th { background: #f7fafc; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üö¥ L'Atelier Clandestin - Shopify Import Tool</h1>
            <p>Transform invoices into ready-to-import Shopify products in minutes</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('process')">üì¶ Process Invoice</button>
            <button class="tab" onclick="showTab('suppliers')">üè≠ Suppliers (<span id="supplier-count">0</span>)</button>
            <button class="tab" onclick="showTab('migration')">üîÑ Migration</button>
        </div>

        <!-- PROCESS TAB -->
        <div id="process-tab">
            <div class="section">
                <h2>üìÑ Upload Today's Invoice</h2>
                <p style="color:#666;margin-bottom:20px;">Upload supplier invoice/packing list to create Shopify products automatically</p>
                
                <div class="form-group">
                    <label>Select Supplier</label>
                    <select id="supplier-select">
                        <option value="">-- Select Supplier --</option>
                    </select>
                </div>

                <div class="file-upload">
                    <input type="file" id="invoice-file" accept=".pdf,.xlsx,.xls,.csv">
                    <p style="margin-top:10px;color:#666;">PDF, Excel, or CSV accepted</p>
                </div>

                <div id="status"></div>

                <div class="btn-row">
                    <button class="btn btn-primary" onclick="processInvoice()" id="process-btn" disabled>‚öôÔ∏è Process</button>
                    <button class="btn btn-success" onclick="downloadCSV()" id="download-btn" disabled>üì• Download Shopify CSV</button>
                </div>
            </div>

            <div id="preview" class="section hidden"></div>
        </div>

        <!-- SUPPLIERS TAB -->
        <div id="suppliers-tab" class="hidden">
            <div class="section">
                <h2>üè≠ Manage Suppliers</h2>
                <button class="btn btn-primary" onclick="showAddSupplier()">‚ûï Add Supplier</button>
            </div>
            <div id="suppliers-list"></div>
            
            <div id="add-supplier-form" class="section hidden">
                <h2>‚ûï Add New Supplier</h2>
                <div class="form-group">
                    <label>Supplier Name</label>
                    <input type="text" id="new-supplier-name" placeholder="Cycles Lambert">
                </div>
                <div class="form-group">
                    <label>Master Catalog (Excel/CSV)</label>
                    <input type="file" id="new-catalog" accept=".xlsx,.xls,.csv">
                </div>
                <div class="form-group">
                    <label>Product Images</label>
                    <input type="file" id="new-images" accept="image/*" multiple>
                </div>
                <div class="form-group">
                    <label>Pricing Strategy</label>
                    <select id="pricing-strategy">
                        <option value="master">Use Master File Prices (Recommended)</option>
                        <option value="invoice">Use Invoice Prices Only</option>
                    </select>
                    <small style="color:#666;display:block;margin-top:5px;">
                        ‚ö†Ô∏è Prices are NEVER calculated - only taken from supplier data
                    </small>
                </div>
                <div class="form-group hidden" id="markup-group">
                    <label>Markup Multiplier (e.g. 2.3)</label>
                    <input type="number" id="markup" value="0" step="0.1" disabled>
                    <small style="color:#999;">Not used - prices come from supplier files only</small>
                </div>
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="saveSupplier()">üíæ Save</button>
                    <button class="btn" onclick="hideAddSupplier()" style="background:#718096;color:white;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- MIGRATION TAB -->
        <div id="migration-tab" class="hidden">
            <div class="section">
                <h2>üîÑ Lightspeed Migration</h2>
                <p style="color:#666;margin-bottom:20px;">One-time import from Lightspeed</p>
                
                <h3 style="margin:20px 0 10px 0;">Products</h3>
                <input type="file" id="ls-products" accept=".xlsx,.xls,.csv" multiple>
                
                <h3 style="margin:20px 0 10px 0;">Customers</h3>
                <input type="file" id="ls-customers" accept=".xlsx,.xls,.csv" multiple>
                
                <div class="btn-row">
                    <button class="btn btn-primary" onclick="processMigration('products')">Process Products</button>
                    <button class="btn btn-primary" onclick="processMigration('customers')">Process Customers</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let suppliers = [];
        let processedData = [];
        
        loadSuppliers();

        async function loadSuppliers() {
            try {
                const result = await window.storage.list('supplier:');
                if (result?.keys) {
                    suppliers = await Promise.all(
                        result.keys.map(async k => {
                            const r = await window.storage.get(k);
                            return r ? JSON.parse(r.value) : null;
                        })
                    );
                    suppliers = suppliers.filter(s => s);
                }
                updateSupplierUI();
            } catch (e) {
                console.log('No suppliers yet');
            }
        }

        function updateSupplierUI() {
            const select = document.getElementById('supplier-select');
            select.innerHTML = '<option value="">-- Select Supplier --</option>';
            suppliers.forEach((s, i) => {
                select.innerHTML += `<option value="${i}">${s.name}</option>`;
            });
            
            document.getElementById('supplier-count').textContent = suppliers.length;
            
            const list = document.getElementById('suppliers-list');
            if (suppliers.length === 0) {
                list.innerHTML = '<div class="status info">No suppliers yet. Add one to get started.</div>';
            } else {
                list.innerHTML = suppliers.map((s, i) => `
                    <div class="supplier-card">
                        <h3>${s.name}</h3>
                        <p>üìÑ ${s.catalogCount || 0} products | üñºÔ∏è ${s.imageCount || 0} images | üí∞ ${s.pricing}</p>
                        <button class="btn" onclick="deleteSupplier(${i})" style="background:#f56565;color:white;margin-top:10px;">Delete</button>
                    </div>
                `).join('');
            }
        }

        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('process-tab').classList.toggle('hidden', tab !== 'process');
            document.getElementById('suppliers-tab').classList.toggle('hidden', tab !== 'suppliers');
            document.getElementById('migration-tab').classList.toggle('hidden', tab !== 'migration');
        }

        function showAddSupplier() {
            document.getElementById('add-supplier-form').classList.remove('hidden');
        }

        function hideAddSupplier() {
            document.getElementById('add-supplier-form').classList.add('hidden');
        }

        async function saveSupplier() {
            const name = document.getElementById('new-supplier-name').value.trim();
            if (!name) return alert('Enter supplier name');
            
            const supplier = {
                id: Date.now(),
                name,
                pricing: document.getElementById('pricing-strategy').value,
                markup: 0, // Not used - prices come from supplier data
                catalog: [],
                images: []
            };

            // Process catalog
            const catalogFile = document.getElementById('new-catalog').files[0];
            if (catalogFile) {
                const data = catalogFile.name.endsWith('.csv') 
                    ? await readCSV(catalogFile)
                    : await readExcel(catalogFile);
                const headers = data[0].map(h => String(h||'').trim().toLowerCase());
                supplier.catalog = data.slice(1).map(row => {
                    const item = {};
                    headers.forEach((h,i) => item[h] = row[i]);
                    return item;
                });
                supplier.catalogCount = supplier.catalog.length;
            }

            // Process images
            const imageFiles = document.getElementById('new-images').files;
            for (const file of imageFiles) {
                if (file.type.startsWith('image/')) {
                    const dataUrl = await readFileAsDataURL(file);
                    supplier.images.push({
                        name: file.name,
                        id: file.name.split('.')[0].toLowerCase().replace(/[^a-z0-9]/g,''),
                        data: dataUrl
                    });
                }
            }
            supplier.imageCount = supplier.images.length;

            await window.storage.set(`supplier:${supplier.id}`, JSON.stringify(supplier));
            suppliers.push(supplier);
            updateSupplierUI();
            hideAddSupplier();
            showStatus(`Supplier "${name}" added!`, 'success');
        }

        async function deleteSupplier(i) {
            if (!confirm(`Delete "${suppliers[i].name}"?`)) return;
            await window.storage.delete(`supplier:${suppliers[i].id}`);
            suppliers.splice(i, 1);
            updateSupplierUI();
        }

        document.getElementById('invoice-file').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('process-btn').disabled = false;
                showStatus(`Loaded: ${this.files[0].name}`, 'success');
            }
        });

        async function processInvoice() {
            const si = document.getElementById('supplier-select').value;
            if (!si) return showStatus('Select a supplier', 'error');
            
            const file = document.getElementById('invoice-file').files[0];
            if (!file) return showStatus('Upload invoice', 'error');

            const supplier = suppliers[si];
            showStatus('Processing...', 'info');

            try {
                // Read invoice
                let data;
                if (file.name.endsWith('.csv')) {
                    data = await readCSV(file);
                } else if (file.name.endsWith('.pdf')) {
                    showStatus('PDF support coming soon! Use Excel/CSV for now.', 'error');
                    return;
                } else {
                    data = await readExcel(file);
                }

                const headers = data[0].map(h => String(h||'').trim().toLowerCase());
                const items = data.slice(1).map(row => {
                    const item = {};
                    headers.forEach((h,i) => item[h] = row[i]);
                    return normalizeLightspeedData(item);
                });

                // Match & enhance
                processedData = items.map((item, i) => {
                    const catalogMatch = findInCatalog(item, supplier.catalog);
                    const image = findImage(item, supplier.images);
                    return buildShopifyProduct(item, catalogMatch, image, supplier, i);
                });

                document.getElementById('download-btn').disabled = false;
                showPreview();
                showStatus(`‚úÖ Processed ${processedData.length} products!`, 'success');
            } catch (e) {
                showStatus(`Error: ${e.message}`, 'error');
            }
        }

        function findInCatalog(item, catalog) {
            const sku = String(item.sku||'').toLowerCase();
            const upc = String(item.upc||'').toLowerCase();
            return catalog.find(p => 
                String(p.sku||p['custom sku']||'').toLowerCase() === sku ||
                String(p.upc||'').toLowerCase() === upc
            );
        }

        function findImage(item, images) {
            const sku = String(item.sku||'').toLowerCase().replace(/[^a-z0-9]/g,'');
            const match = images.find(img => img.id === sku || img.id.includes(sku) || sku.includes(img.id));
            return match ? match.data : '';
        }

        function buildShopifyProduct(item, catalog, image, supplier, i) {
            const merged = {...item, ...(catalog||{})};
            
            // CRITICAL: Never calculate prices - only use supplier data
            // Priority: 1) Master file  2) Invoice  3) Leave blank
            const retailPrice = merged.price || merged['retail price'] || merged['sell price'] || merged.msrp || '';
            const costPrice = merged.cost || merged['default cost'] || merged['cost price'] || merged['wholesale price'] || '';
            const comparePrice = merged.msrp || merged['compare at price'] || merged['list price'] || '';

            // Warn if no price found
            if (!retailPrice) {
                console.warn(`‚ö†Ô∏è No retail price for: ${merged.name || merged.item}`);
            }

            return {
                'Handle': (merged.sku||merged['custom sku']||`auto-${i}`).toLowerCase().replace(/[^a-z0-9]/g,'-'),
                'Title': merged.name||merged.item||merged.title||'Product',
                'Body (HTML)': generateDescription(merged),
                'Vendor': merged.vendor||merged.brand||'L\'Atelier Clandestin',
                'Product Category': buildProductCategory(merged),
                'Type': normalizeProductType(merged),
                'Tags': generateStandardizedTags(merged),
                'Published': 'TRUE',
                'Option1 Name': 'Title',
                'Option1 Value': 'Default Title',
                'Variant SKU': merged.sku||merged['custom sku']||`AUTO-${i}`,
                'Variant Grams': '0',
                'Variant Inventory Tracker': 'shopify',
                'Variant Inventory Qty': merged.qty||merged['qty.']||'0',
                'Variant Inventory Policy': 'deny',
                'Variant Fulfillment Service': 'manual',
                'Variant Price': cleanPrice(retailPrice),
                'Variant Compare At Price': cleanPrice(comparePrice),
                'Variant Requires Shipping': 'TRUE',
                'Variant Taxable': 'TRUE',
                'Variant Barcode': merged.upc||merged.ean||'',
                'Image Src': image,
                'Image Position': '1',
                'Image Alt Text': `${merged.brand||''} ${merged.name||merged.item||'product'}`.trim(),
                'Gift Card': 'FALSE',
                'SEO Title': `${merged.brand||''} ${merged.name||merged.item||'Product'} | L'Atelier Clandestin`.substring(0,70),
                'SEO Description': `Achetez ${merged.brand||''} ${merged.name||merged.item||'product'} chez L'Atelier Clandestin. Livraison rapide.`.substring(0,320),
                'Variant Weight Unit': 'g',
                'Cost per item': cleanPrice(costPrice),
                'Status': 'active'
            };
        }

        function normalizeLightspeedData(item) {
            return {
                sku: item['custom sku']||item['manufact. sku']||item.sku,
                upc: item.upc,
                ean: item.ean,
                name: item.item||item.name,
                qty: item['qty.']||item.qty,
                price: item.price,
                cost: item['default cost']||item.cost,
                msrp: item.msrp,
                brand: item.brand,
                vendor: item.vendor,
                category: item.category,
                'subcategory 1': item['subcategory 1'],
                'subcategory 2': item['subcategory 2']
            };
        }

        function normalizeProductType(item) {
            const cat = (item.category||'').toLowerCase();
            const sub = (item['subcategory 1']||'').toLowerCase();
            
            if (cat.includes('composant')||sub.includes('composant')) return 'composantes';
            if (cat.includes('access')||sub.includes('access')) return 'accessoires';
            if (cat.includes('pneu')||cat.includes('tire')) return 'pneus';
            if (cat.includes('velo')||cat.includes('bike')) return 'velos';
            if (cat.includes('service')) return 'services';
            if (cat.includes('vetement')||cat.includes('cloth')) return 'vetements';
            return 'composantes';
        }

        function buildProductCategory(item) {
            const cats = [];
            if (item.category) cats.push(item.category);
            for (let i = 1; i <= 9; i++) {
                if (item[`subcategory ${i}`]) cats.push(item[`subcategory ${i}`]);
            }
            return cats.join(' > ');
        }

        function generateStandardizedTags(item) {
            const tags = new Set();
            if (item.brand) tags.add(item.brand);
            
            const type = normalizeProductType(item);
            const sub = (item['subcategory 1']||'').toLowerCase();
            
            if (type === 'composantes') {
                if (sub.includes('pedale')) tags.add('comp_pedales');
                if (sub.includes('frein')) tags.add('comp_freins');
                if (sub.includes('roue')) tags.add('comp_roues');
            }
            if (type === 'accessoires') {
                if (sub.includes('lumiere')||sub.includes('light')) tags.add('acc_lumiere');
                if (sub.includes('cadenas')) tags.add('acc_cadenas');
            }
            if (type === 'services') {
                if (sub.includes('mise au point')) tags.add('srv_miseaupoint');
                if (sub.includes('suspension')) tags.add('srv_suspensions');
            }
            
            return Array.from(tags).join(', ');
        }

        function generateDescription(item) {
            let html = `<h2>${item.name||item.item||'Product'}</h2>`;
            if (item.brand) html += `<p><strong>Marque:</strong> ${item.brand}</p>`;
            html += `<h3>Sp√©cifications</h3><ul>`;
            if (item.sku||item['custom sku']) html += `<li><strong>SKU:</strong> ${item.sku||item['custom sku']}</li>`;
            if (item.upc) html += `<li><strong>UPC:</strong> ${item.upc}</li>`;
            html += `</ul>`;
            return html;
        }

        function cleanPrice(p) {
            if (!p) return '';
            return String(p).replace(/[^0-9.]/g,'');
        }

        function showPreview() {
            const preview = document.getElementById('preview');
            preview.classList.remove('hidden');
            preview.innerHTML = `
                <h2>üìä Preview (${processedData.length} products)</h2>
                <table>
                    <tr><th>SKU</th><th>Title</th><th>Type</th><th>Price</th><th>Qty</th></tr>
                    ${processedData.slice(0,10).map(p => `
                        <tr>
                            <td>${p['Variant SKU']}</td>
                            <td>${p.Title}</td>
                            <td>${p.Type}</td>
                            <td>$${p['Variant Price']}</td>
                            <td>${p['Variant Inventory Qty']}</td>
                        </tr>
                    `).join('')}
                </table>
            `;
        }

        function downloadCSV() {
            const csv = Papa.unparse(processedData);
            const blob = new Blob([csv], {type:'text/csv'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shopify-import-${Date.now()}.csv`;
            a.click();
        }

        function showStatus(msg, type) {
            document.getElementById('status').className = `status ${type}`;
            document.getElementById('status').textContent = msg;
        }

        async function readCSV(file) {
            return new Promise((resolve, reject) => {
                Papa.parse(file, {
                    complete: r => resolve(r.data),
                    error: reject,
                    skipEmptyLines: true
                });
            });
        }

        async function readExcel(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => {
                    const data = new Uint8Array(e.target.result);
                    const wb = XLSX.read(data, {type:'array'});
                    const sheet = wb.Sheets[wb.SheetNames[0]];
                    resolve(XLSX.utils.sheet_to_json(sheet, {header:1}));
                };
                reader.onerror = reject;
                reader.readAsArrayBuffer(file);
            });
        }

        async function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function processMigration(type) {
            if (type === 'products') {
                const files = document.getElementById('ls-products').files;
                if (files.length === 0) return showStatus('Upload Lightspeed products export', 'error');
                
                showStatus('Processing Lightspeed data...', 'info');
                
                try {
                    let allProducts = [];
                    
                    for (const file of files) {
                        const data = file.name.endsWith('.csv') 
                            ? await readCSV(file)
                            : await readExcel(file);
                        
                        const headers = data[0].map(h => String(h||'').trim().toLowerCase());
                        const products = data.slice(1).map(row => {
                            const item = {};
                            headers.forEach((h,i) => item[h] = row[i]);
                            return normalizeLightspeedData(item);
                        });
                        
                        allProducts = allProducts.concat(products);
                    }
                    
                    // Clean, enhance, and build Shopify products
                    processedData = allProducts.map((item, i) => {
                        // Clean the data
                        const cleaned = cleanLightspeedData(item);
                        
                        // Match to supplier master files
                        const supplierData = findSupplierData(cleaned);
                        
                        // Merge and enhance
                        const enhanced = enhanceWithSupplierData(cleaned, supplierData);
                        
                        // Find images
                        const image = findProductImage(enhanced);
                        
                        // Build final Shopify product
                        return buildCleanShopifyProduct(enhanced, image, i);
                    });
                    
                    showPreview();
                    showStatus(`‚úÖ Processed ${processedData.length} Lightspeed products - cleaned, enhanced, and ready for Shopify!`, 'success');
                    document.getElementById('download-btn').disabled = false;
                    
                } catch (e) {
                    showStatus(`Error: ${e.message}`, 'error');
                }
            } else {
                showStatus('Customer migration coming soon!', 'info');
            }
        }

        function cleanLightspeedData(item) {
            return {
                // Clean text fields - fix caps, accents, formatting
                name: cleanText(item.name || item.item || ''),
                brand: cleanText(item.brand || ''),
                vendor: cleanText(item.vendor || ''),
                
                // Pricing - keep as numbers
                price: item.price,
                cost: item.cost,
                msrp: item.msrp,
                
                // Identifiers
                sku: item.sku,
                upc: item.upc,
                ean: item.ean,
                
                // Inventory
                qty: item.qty,
                
                // Categories - clean and translate
                category: cleanAndTranslate(item.category || ''),
                subcategory1: cleanAndTranslate(item['subcategory 1'] || ''),
                subcategory2: cleanAndTranslate(item['subcategory 2'] || ''),
                
                // Other
                season: item.season,
                tax: item.tax
            };
        }

        function cleanText(text) {
            if (!text) return '';
            
            text = String(text).trim();
            
            // Fix all caps
            if (text === text.toUpperCase() && text.length > 3) {
                text = text.toLowerCase();
            }
            
            // Title case for proper nouns
            text = text.split(' ').map(word => {
                // Keep known brands in proper case
                const brands = ['Shimano', 'SRAM', 'Look', 'Mavic', 'Fox', 'RockShox', 'Campagnolo'];
                const match = brands.find(b => b.toLowerCase() === word.toLowerCase());
                if (match) return match;
                
                // Title case for other words
                if (word.length <= 2) return word.toLowerCase(); // de, le, la, etc.
                return word.charAt(0).toUpperCase() + word.slice(1).toLowerCase();
            }).join(' ');
            
            // Fix common accent issues
            text = text.replace(/pedales/gi, 'p√©dales')
                       .replace(/velo/gi, 'v√©lo')
                       .replace(/chaine/gi, 'cha√Æne')
                       .replace(/frein/gi, 'frein')
                       .replace(/eclairage/gi, '√©clairage');
            
            return text;
        }

        function cleanAndTranslate(text) {
            if (!text) return '';
            
            text = cleanText(text);
            
            // Translate common English terms to French
            const translations = {
                'brake': 'frein',
                'brakes': 'freins',
                'wheel': 'roue',
                'wheels': 'roues',
                'tire': 'pneu',
                'tires': 'pneus',
                'chain': 'cha√Æne',
                'pedal': 'p√©dale',
                'pedals': 'p√©dales',
                'saddle': 'selle',
                'handlebar': 'guidon',
                'fork': 'fourche',
                'frame': 'cadre',
                'gear': 'vitesse',
                'light': 'lumi√®re',
                'lights': 'lumi√®res',
                'lock': 'cadenas',
                'pump': 'pompe',
                'bottle': 'bidon',
                'helmet': 'casque',
                'accessories': 'accessoires',
                'components': 'composantes',
                'road': 'route',
                'mountain': 'montagne'
            };
            
            Object.keys(translations).forEach(en => {
                const fr = translations[en];
                const regex = new RegExp(`\\b${en}\\b`, 'gi');
                text = text.replace(regex, fr);
            });
            
            return text;
        }

        function findSupplierData(cleaned) {
            // Search all supplier master files for matching product
            for (const supplier of suppliers) {
                if (!supplier.catalog || supplier.catalog.length === 0) continue;
                
                const match = supplier.catalog.find(p => {
                    const pSku = String(p.sku||p['custom sku']||'').toLowerCase();
                    const pUpc = String(p.upc||'').toLowerCase();
                    const pName = String(p.name||p.item||'').toLowerCase();
                    
                    const sku = String(cleaned.sku||'').toLowerCase();
                    const upc = String(cleaned.upc||'').toLowerCase();
                    const name = String(cleaned.name||'').toLowerCase();
                    
                    // Match by SKU or UPC (exact)
                    if (sku && pSku === sku) return true;
                    if (upc && pUpc === upc) return true;
                    
                    // Match by name similarity (fuzzy)
                    if (name && pName && pName.includes(name.substring(0, 15))) return true;
                    
                    return false;
                });
                
                if (match) {
                    return {
                        supplier: supplier.name,
                        data: match
                    };
                }
            }
            
            return null;
        }

        function enhanceWithSupplierData(cleaned, supplierMatch) {
            if (!supplierMatch) return cleaned;
            
            const supplier = supplierMatch.data;
            
            // Merge data - supplier data fills gaps
            return {
                ...cleaned,
                
                // Use supplier description if better/longer
                description: supplier.description || cleaned.description || '',
                
                // Use supplier specs if available
                specs: supplier.specs || supplier.specifications || '',
                
                // Fill missing pricing
                msrp: cleaned.msrp || supplier.msrp || supplier['list price'] || '',
                cost: cleaned.cost || supplier.cost || supplier['default cost'] || '',
                
                // Fill missing identifiers
                upc: cleaned.upc || supplier.upc || '',
                ean: cleaned.ean || supplier.ean || '',
                
                // Additional details
                weight: supplier.weight || supplier.grams || '',
                material: supplier.material || '',
                color: supplier.color || supplier.colour || '',
                size: supplier.size || '',
                
                // Flag as enhanced
                enhanced: true,
                enhancedBy: supplierMatch.supplier
            };
        }

        function findProductImage(product) {
            // Search all supplier images
            const sku = String(product.sku||'').toLowerCase().replace(/[^a-z0-9]/g,'');
            const upc = String(product.upc||'').toLowerCase().replace(/[^a-z0-9]/g,'');
            
            for (const supplier of suppliers) {
                if (!supplier.images || supplier.images.length === 0) continue;
                
                const match = supplier.images.find(img => {
                    const id = img.id;
                    return id === sku || id === upc || 
                           id.includes(sku) || id.includes(upc) ||
                           sku.includes(id) || upc.includes(id);
                });
                
                if (match) return match.data;
            }
            
            return '';
        }

        function buildCleanShopifyProduct(product, image, index) {
            // Build professional French description
            let description = `<h2>${product.name}</h2>`;
            
            if (product.brand) {
                description += `<p><strong>Marque:</strong> ${product.brand}</p>`;
            }
            
            if (product.description) {
                description += `<p>${product.description}</p>`;
            }
            
            // Add specifications section
            description += `<h3>Sp√©cifications</h3><ul>`;
            
            if (product.sku) description += `<li><strong>SKU:</strong> ${product.sku}</li>`;
            if (product.upc) description += `<li><strong>UPC:</strong> ${product.upc}</li>`;
            if (product.weight) description += `<li><strong>Poids:</strong> ${product.weight}</li>`;
            if (product.material) description += `<li><strong>Mat√©riau:</strong> ${product.material}</li>`;
            if (product.color) description += `<li><strong>Couleur:</strong> ${product.color}</li>`;
            if (product.size) description += `<li><strong>Taille:</strong> ${product.size}</li>`;
            
            description += `</ul>`;
            
            // Add specs if available
            if (product.specs) {
                description += `<h3>D√©tails Techniques</h3><p>${product.specs}</p>`;
            }
            
            // Add note if enhanced
            if (product.enhanced) {
                description += `<p style="font-size:11px;color:#666;"><em>Donn√©es enrichies par ${product.enhancedBy}</em></p>`;
            }
            
            // CRITICAL: Use supplier prices ONLY - never calculate
            const retailPrice = product.price || product.msrp || '';
            const costPrice = product.cost || '';
            const comparePrice = product.msrp || '';
            
            // Warn if missing prices
            if (!retailPrice) {
                console.warn(`‚ö†Ô∏è No retail price for: ${product.name}`);
            }
            
            return {
                'Handle': (product.sku || `product-${index}`).toLowerCase().replace(/[^a-z0-9]/g, '-'),
                'Title': product.name || 'Produit',
                'Body (HTML)': description,
                'Vendor': product.vendor || product.brand || 'L\'Atelier Clandestin',
                'Product Category': buildProductCategory(product),
                'Type': normalizeProductType(product),
                'Tags': generateStandardizedTags(product),
                'Published': 'TRUE',
                'Option1 Name': 'Title',
                'Option1 Value': 'Default Title',
                'Option1 Linked To': '',
                'Option2 Name': '',
                'Option2 Value': '',
                'Option2 Linked To': '',
                'Option3 Name': '',
                'Option3 Value': '',
                'Option3 Linked To': '',
                'Variant SKU': product.sku || `AUTO-${index}`,
                'Variant Grams': product.weight || '0',
                'Variant Inventory Tracker': 'shopify',
                'Variant Inventory Qty': product.qty || '0',
                'Variant Inventory Policy': 'deny',
                'Variant Fulfillment Service': 'manual',
                'Variant Price': cleanPrice(retailPrice),
                'Variant Compare At Price': cleanPrice(comparePrice),
                'Variant Requires Shipping': 'TRUE',
                'Variant Taxable': product.tax === 'Yes' ? 'TRUE' : 'TRUE',
                'Unit Price Total Measure': '',
                'Unit Price Total Measure Unit': '',
                'Unit Price Base Measure': '',
                'Unit Price Base Measure Unit': '',
                'Variant Barcode': product.upc || product.ean || '',
                'Image Src': image,
                'Image Position': '1',
                'Image Alt Text': `${product.brand || ''} ${product.name || 'produit'}`.trim(),
                'Gift Card': 'FALSE',
                'SEO Title': `${product.brand || ''} ${product.name || 'Produit'} | L'Atelier Clandestin`.substring(0, 70),
                'SEO Description': `Achetez ${product.brand || ''} ${product.name || 'produit'} chez L'Atelier Clandestin √† Montr√©al. Pi√®ces et accessoires de v√©lo de qualit√© sup√©rieure.`.substring(0, 320),
                'Variant Image': '',
                'Variant Weight Unit': 'g',
                'Variant Tax Code': '',
                'Cost per item': cleanPrice(costPrice),
                'Status': 'active'
            };
        }
    </script>
</body>
</html>